<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="./favicon.ico" sizes="16x16" type="image/x-icon">
    <link rel="icon" href="./favicon-16x16.png" sizes="16x16" type="image/png">
    <link rel="icon" href="./favicon-32x32.png" sizes="32x32" type="image/png">
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" sizes="180x180">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸ªäººå¯¼èˆª | My Nav</title>
    <meta name="description" content="ä¸ªäººç§æœ‰å¯¼èˆªé¡µ">
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media', 
            theme: {
                extend: {
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#0b0f19',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(4px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* åŸºç¡€è®¾ç½® */
        body {
            -webkit-tap-highlight-color: transparent;
        }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        ::-webkit-scrollbar { width: 0px; height: 0px; }
        
        /* æ¨ªå‘æ»šåŠ¨å®¹å™¨ä¼˜åŒ– */
        .scroll-container {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            mask-image: linear-gradient(to right, transparent, black 12px, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent 0%, black 12px, black calc(100% - 12px), transparent 100%);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-950 dark:text-gray-200 transition-colors duration-300 min-h-screen flex flex-col">

    <!-- é¡¶éƒ¨ Header & æœç´¢ -->
    <header class="sticky top-0 z-50 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl border-b border-gray-200/50 dark:border-gray-800/50 shadow-sm transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between gap-3">
            <!-- Logo -->
            <div class="font-bold text-lg tracking-tight text-blue-600 dark:text-blue-500 shrink-0 cursor-pointer select-none active:opacity-70 transition-opacity" onclick="resetView()">
                PasserJ's Nav
            </div>

            <!-- æœç´¢æ¡† -->
            <div class="flex-1 max-w-lg">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-gray-400 group-focus-within:text-blue-500 transition-colors" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <input 
                        type="text" 
                        id="searchInput"
                        class="block w-full pl-9 pr-3 py-2 border border-gray-200 dark:border-gray-700 rounded-xl leading-5 bg-gray-100/50 dark:bg-gray-800/50 placeholder-gray-500 focus:outline-none focus:bg-white dark:focus:bg-black focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500/50 transition-all duration-200 text-sm"
                        placeholder="æœç´¢..."
                    >
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="flex-grow max-w-7xl mx-auto w-full px-0 sm:px-6 lg:px-8 py-4 min-h-[50vh]" id="mainContainer">
        
        <!-- é»˜è®¤å±•ç¤ºåŒºåŸŸ -->
        <div id="projectsContainer" class="space-y-8 pb-10">
            <div class="flex justify-center items-center h-40 text-gray-400 gap-2">
                <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-sm">Loading...</span>
            </div>
        </div>

        <!-- æœç´¢ç»“æœåŒºåŸŸ -->
        <div id="searchResultsContainer" class="hidden px-4 sm:px-0 space-y-8 pb-10"></div>
    </main>

    <!-- é€»è¾‘è„šæœ¬ -->
    <script>
        let fullData = null;           
        let projectKeys = [];          
        let activeCategories = {}; 

        // === å›¾æ ‡å¤„ç†é€»è¾‘å¼€å§‹ ===
        
        // å½“å›¾ç‰‡åŠ è½½å®Œæˆï¼ˆæ— è®ºæˆåŠŸä¸å¦ï¼‰
        window.handleImageLoad = function(img) {
            // Yandex API ç‰¹æ€§ï¼šå¦‚æœæœªæ‰¾åˆ°å›¾æ ‡ï¼Œå¸¸è¿”å› 1x1 çš„é€æ˜åƒç´ 
            // å¦‚æœæ£€æµ‹åˆ°æ˜¯ 1x1ï¼Œæˆ‘ä»¬è§†ä¸ºåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡é€‰æ–¹æ¡ˆ
            if (img.naturalWidth === 1 && img.naturalHeight === 1) {
                handleImageError(img);
            } else {
                // åŠ è½½æˆåŠŸä¸”å°ºå¯¸æ­£å¸¸ï¼Œç¡®ä¿æ˜¾ç¤º
                img.style.opacity = '1';
            }
        };

        // å½“å›¾ç‰‡åŠ è½½å‡ºé”™ï¼ˆæˆ–è¢«è§†ä¸ºå‡ºé”™ï¼‰
        window.handleImageError = function(img) {
            // é˜²æ­¢æ­»å¾ªç¯
            if (img.dataset.state === 'failed') return;

            // å¦‚æœè¿˜æ²¡è¯•è¿‡ç›´è¿ /favicon.ico
            if (!img.dataset.triedDirect) {
                img.dataset.triedDirect = 'true';
                try {
                    const url = new URL(img.dataset.url);
                    // å°è¯•åŠ è½½ç½‘ç«™æ ¹ç›®å½•çš„ favicon.ico
                    img.src = `${url.origin}/favicon.ico`;
                } catch (e) {
                    fail(img);
                }
            } else {
                // ä¸¤æ¬¡éƒ½å¤±è´¥äº†
                fail(img);
            }
        };

        // æœ€ç»ˆå¤±è´¥å¤„ç†ï¼šéšè—å›¾ç‰‡ï¼Œéœ²å‡ºåº•ä¸‹çš„å½©è‰²é¦–å­—æ¯å±‚
        function fail(img) {
            img.dataset.state = 'failed';
            img.style.opacity = '0'; // å…³é”®ï¼šéšè— imgï¼Œæ˜¾ç¤ºåº•å±‚çš„ div
        }

        // === å›¾æ ‡å¤„ç†é€»è¾‘ç»“æŸ ===

        async function init() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                fullData = await response.json();
                projectKeys = Object.keys(fullData);

                if (projectKeys.length > 0) {
                    projectKeys.forEach(key => activeCategories[key] = 0);
                    renderAllProjects();
                } else {
                    document.getElementById('projectsContainer').innerHTML = '<p class="text-center text-gray-500 mt-10">æš‚æ— æ•°æ®</p>';
                }
            } catch (error) {
                console.error(error);
                document.getElementById('projectsContainer').innerHTML = `
                    <div class="text-center text-red-500 py-10 px-4">
                        <p class="font-bold">åŠ è½½å¤±è´¥</p>
                        <p class="text-xs mt-2 text-gray-400">è¯·æ£€æŸ¥ data.json</p>
                    </div>
                `;
            }
        }

        function renderAllProjects() {
            const container = document.getElementById('projectsContainer');
            
            container.innerHTML = projectKeys.map((key, idx) => {
                const categories = fullData[key];
                const gridsHTML = categories.map((cat, catIdx) => {
                    const isVisible = catIdx === 0;
                    const displayClass = isVisible ? 'grid animate-fade-in' : 'hidden';
                    
                    return `
                        <div id="grid-${key}-${catIdx}" class="${displayClass} grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 sm:gap-4">
                            ${cat.items.map(item => createCard(item)).join('')}
                        </div>
                    `;
                }).join('');

                return `
                <section id="section-${key}" class="animate-fade-in group">
                    ${idx !== 0 ? '<div class="h-px bg-gray-100 dark:bg-gray-800/60 mx-4 sm:mx-0 mb-6"></div>' : ''}
                    
                    <div class="relative mb-4">
                         <nav id="tabs-${key}" class="scroll-container flex space-x-2 overflow-x-auto px-4 sm:px-1 pb-2 pt-1">
                            ${renderTabButtons(key)}
                         </nav>
                    </div>

                    <div class="min-h-[100px] px-4 sm:px-0">
                        ${gridsHTML}
                    </div>
                </section>
                `;
            }).join('');
        }

        function renderTabButtons(projectKey) {
            const categories = fullData[projectKey] || [];
            const activeIndex = activeCategories[projectKey];

            if (categories.length === 0) return '<span class="text-xs text-gray-400">æ— åˆ†ç±»</span>';

            return categories.map((cat, index) => {
                const isActive = index === activeIndex;
                return `
                    <button 
                        data-idx="${index}"
                        onclick="switchCategory('${projectKey}', ${index}, this)"
                        class="tab-btn shrink-0 whitespace-nowrap px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 ease-out select-none outline-none focus-visible:ring-2 focus-visible:ring-blue-500 ${
                            isActive 
                            ? 'bg-gray-800 text-white dark:bg-gray-100 dark:text-gray-900 shadow-md transform scale-100 font-bold' 
                            : 'bg-white text-gray-600 border border-gray-100 hover:bg-gray-50 hover:border-gray-200 dark:bg-gray-800/50 dark:text-gray-400 dark:border-gray-700/50 dark:hover:bg-gray-800 dark:hover:text-gray-200'
                        }"
                    >
                        ${cat.category}
                    </button>
                `;
            }).join('');
        }

        window.switchCategory = function(projectKey, index, btnElement) {
            const oldIndex = activeCategories[projectKey];
            if (oldIndex === index) return; 

            activeCategories[projectKey] = index;

            const oldGrid = document.getElementById(`grid-${projectKey}-${oldIndex}`);
            const newGrid = document.getElementById(`grid-${projectKey}-${index}`);
            
            if (oldGrid) {
                oldGrid.classList.add('hidden');
                oldGrid.classList.remove('grid', 'animate-fade-in');
            }
            if (newGrid) {
                newGrid.classList.remove('hidden');
                newGrid.classList.add('grid', 'animate-fade-in');
            }

            const container = document.getElementById(`tabs-${projectKey}`);
            const buttons = container.getElementsByTagName('button');
            
            for (let btn of buttons) {
                btn.className = 'tab-btn shrink-0 whitespace-nowrap px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 ease-out select-none outline-none focus-visible:ring-2 focus-visible:ring-blue-500 bg-white text-gray-600 border border-gray-100 hover:bg-gray-50 hover:border-gray-200 dark:bg-gray-800/50 dark:text-gray-400 dark:border-gray-700/50 dark:hover:bg-gray-800 dark:hover:text-gray-200';
            }
            
            if (btnElement) {
                btnElement.className = 'tab-btn shrink-0 whitespace-nowrap px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 ease-out select-none outline-none focus-visible:ring-2 focus-visible:ring-blue-500 bg-gray-800 text-white dark:bg-gray-100 dark:text-gray-900 shadow-md transform scale-100 font-bold';
                btnElement.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        function createCard(item) {
            // åˆå§‹å°è¯•ä½¿ç”¨ Yandex
            const primaryIcon = `https://favicon.yandex.net/favicon/${extractHostname(item.url)}?size=32`;
            
            const safeName = item.name ? item.name.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
            const safeDesc = item.desc ? item.desc.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
            const firstChar = safeName.charAt(0).toUpperCase();
            const bgColor = getColorFromName(safeName);

            // ç»“æ„ï¼š
            // åº•å±‚ï¼šdiv (çº¯è‰²èƒŒæ™¯ + æ–‡å­—) -> æ°¸è¿œå­˜åœ¨
            // ä¸Šå±‚ï¼šimg (å¸¦ç™½è‰²èƒŒæ™¯) -> åŠ è½½æˆåŠŸé®ä½åº•å±‚ï¼Œå¤±è´¥é€æ˜éœ²å‡ºåº•å±‚
            return `
            <a href="${item.url}" target="_blank" rel="noopener noreferrer" 
               class="group relative flex items-center p-3 sm:p-4 bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700/50 shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)] hover:shadow-lg hover:-translate-y-0.5 hover:border-blue-500/30 dark:hover:border-blue-500/30 transition-all duration-300 h-full overflow-hidden">
                
                <div class="flex-shrink-0 mr-3 w-10 h-10 sm:w-11 sm:h-11 rounded-full overflow-hidden shadow-inner relative bg-gray-50 dark:bg-gray-700/50">
                    <!-- åº•å±‚ Fallback (ç›¸å½“äºä½ ä»£ç ä¸­çš„ SVG é€»è¾‘) -->
                    <div class="absolute inset-0 flex items-center justify-center text-white/90 text-sm sm:text-base font-bold shadow-inner z-0 select-none" 
                         style="background-color: ${bgColor};">
                        ${firstChar}
                    </div>
                    
                    <!-- ä¸Šå±‚ Image -->
                    <img 
                        src="${primaryIcon}" 
                        data-url="${item.url}"
                        alt="${safeName}" 
                        class="relative z-10 w-full h-full object-contain p-1.5 transition-opacity duration-300 bg-white dark:bg-gray-800"
                        loading="lazy"
                        onload="handleImageLoad(this)"
                        onerror="handleImageError(this)"
                    />
                </div>

                <div class="flex-1 min-w-0 flex flex-col justify-center">
                    <h3 class="text-sm font-semibold text-gray-800 dark:text-gray-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 truncate transition-colors">
                        ${safeName}
                    </h3>
                    <p class="text-[10px] sm:text-xs text-gray-400 dark:text-gray-500 truncate mt-0.5 font-medium">
                        ${safeDesc || extractDomain(item.url)}
                    </p>
                </div>
            </a>`;
        }

        window.resetView = function() {
            const input = document.getElementById('searchInput');
            input.value = '';
            input.blur();
            toggleSearchMode(false);
        }

        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (val.length > 0) {
                toggleSearchMode(true);
                renderSearchResults(val);
            } else {
                toggleSearchMode(false);
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === '/' && document.activeElement !== searchInput) {
                e.preventDefault();
                searchInput.focus();
            }
            if (e.key === 'Enter') {
                const val = searchInput.value.trim();
                if (val) window.open(`https://www.google.com/search?q=${encodeURIComponent(val)}`, '_blank');
            }
        });

        function toggleSearchMode(isSearch) {
            const projectsDiv = document.getElementById('projectsContainer');
            const resultsDiv = document.getElementById('searchResultsContainer');
            if (isSearch) {
                projectsDiv.classList.add('hidden');
                resultsDiv.classList.remove('hidden');
            } else {
                projectsDiv.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
            }
        }

        function renderSearchResults(filterText) {
            const resultsDiv = document.getElementById('searchResultsContainer');
            let matchedGroups = []; 
            projectKeys.forEach(pKey => {
                fullData[pKey].forEach(cat => {
                    const matches = cat.items.filter(item => 
                        (item.name + item.desc + item.url).toLowerCase().includes(filterText.toLowerCase())
                    );
                    if (matches.length > 0) {
                        matchedGroups.push({ title: cat.category, items: matches });
                    }
                });
            });

            if (matchedGroups.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="text-center py-20 animate-fade-in">
                        <div class="text-4xl mb-4 grayscale opacity-50">ğŸ”</div>
                        <h3 class="text-base font-medium text-gray-600 dark:text-gray-400">æœªæ‰¾åˆ° "${filterText}"</h3>
                        <p class="text-gray-400 text-xs mt-2">æŒ‰ Enter å°è¯• Google æœç´¢</p>
                    </div>`;
                return;
            }

            resultsDiv.innerHTML = matchedGroups.map(group => `
                <div class="animate-fade-in">
                    <h3 class="text-xs font-bold text-gray-400 dark:text-gray-500 mb-3 uppercase tracking-wider pl-1">
                        ${group.title}
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 sm:gap-4">
                        ${group.items.map(item => createCard(item)).join('')}
                    </div>
                </div>
            `).join('');
        }

        function extractHostname(urlStr) { try { return new URL(urlStr).hostname; } catch (e) { return ''; } }
        function extractDomain(urlStr) { try { return new URL(urlStr).hostname.replace(/^www\./, ''); } catch(e) { return ''; } }
        function getColorFromName(name) {
            // ä½¿ç”¨ä¸ä½ ä»£ç ç¤ºä¾‹ç±»ä¼¼çš„é²œè‰³è‰²ç³»
            const colors = ["#1abc9c", "#2ecc71", "#3498db", "#9b59b6", "#34495e", "#f1c40f", "#e67e22", "#e74c3c", "#f39c12", "#d35400"];
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }

        init();
    </script>
</body>
</html>